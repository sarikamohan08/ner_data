import pytesseract
from pdf2image import convert_from_path
import camelot
import cv2
import os
import pandas as pd

# Path to Tesseract executable (update this path according to your system)
pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'

# Function to extract text from specified pages of a PDF using PyTesseract OCR
def extract_text_from_pdf(pdf_path, pages=None):
    # Convert specified pages of the PDF to images
    images = convert_from_path(pdf_path, first_page=pages[0], last_page=pages[-1] if pages else None)

    # Extract text from each image using OCR
    full_text = ""
    for i, image in enumerate(images):
        # Save the image temporarily
        image_path = f"temp_page_{i}.png"
        image.save(image_path, "PNG")

        # Preprocess the image (optional, improves OCR accuracy)
        img = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)
        _, img = cv2.threshold(img, 150, 255, cv2.THRESH_BINARY)

        # Perform OCR on the preprocessed image
        text = pytesseract.image_to_string(img)
        full_text += text + "\n"

        # Remove the temporary image file
        os.remove(image_path)

    return full_text

# Function to extract tables from specified pages of a PDF using Camelot and save them in a single Excel file
def extract_tables_from_pdf(pdf_path, output_folder, pdf_name, pages=None):
    # Extract tables from specified pages using Camelot
    tables = camelot.read_pdf(pdf_path, pages=','.join(map(str, pages)) if pages else 'all')

    # Create a Pandas Excel writer object
    excel_file = os.path.join(output_folder, f"{pdf_name}_tables.xlsx")
    with pd.ExcelWriter(excel_file, engine='openpyxl') as writer:
        for i, table in enumerate(tables):
            # Save each table to a separate sheet in the Excel file
            table.df.to_excel(writer, sheet_name=f"Table_{i + 1}", index=False)

    print(f"Extracted {len(tables)} tables and saved to {excel_file}")

# Function to process PDFs based on IDs from Excel and specified pages
def process_pdfs_from_excel(excel_file, root_folder, output_base_folder, pages=None):
    # Read the Excel file
    df = pd.read_excel(excel_file)

    # Ensure the output base folder exists
    if not os.path.exists(output_base_folder):
        os.makedirs(output_base_folder)

    # Iterate through the ID column
    for id_value in df['ID']:  # Replace 'ID' with the actual column name
        # Search for PDF files containing the ID in the root folder
        for root, _, files in os.walk(root_folder):
            for file in files:
                if str(id_value) in file and file.lower().endswith(".pdf"):
                    pdf_path = os.path.join(root, file)
                    print(f"Processing PDF: {pdf_path}")

                    # Create a subfolder for the PDF's extracted content
                    pdf_name = os.path.splitext(file)[0]
                    output_folder = os.path.join(output_base_folder, pdf_name)
                    if not os.path.exists(output_folder):
                        os.makedirs(output_folder)

                    # Extract text from specified pages of the PDF
                    extracted_text = extract_text_from_pdf(pdf_path, pages=pages)
                    text_output_file = os.path.join(output_folder, f"{pdf_name}.txt")
                    with open(text_output_file, "w", encoding="utf-8") as text_file:
                        text_file.write(extracted_text)
                    print(f"Text extracted and saved to {text_output_file}")

                    # Extract tables from specified pages of the PDF and save them in a single Excel file
                    extract_tables_from_pdf(pdf_path, output_folder, pdf_name, pages=pages)

# Example usage
if __name__ == "__main__":
    excel_file = "ids.xlsx"  # Path to your Excel file
    root_folder = "pdf_root_folder"  # Root folder containing PDF files
    output_base_folder = "extracted_content"  # Base folder to save extracted content
    pages_to_extract = [1, 3, 5]  # Specify the pages to extract (e.g., pages 1, 3, and 5)

    process_pdfs_from_excel(excel_file, root_folder, output_base_folder, pages=pages_to_extract)
