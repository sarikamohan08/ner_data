import pandas as pd

def process_data(file_path):
    # Load all sheets in the Excel file
    all_sheets = pd.read_excel(file_path, sheet_name=None)

    # Prepare an empty list to hold the processed rows
    output_rows = []

    # Iterate over each sheet
    for sheet_name, sheet_data in all_sheets.items():
        # Get the list of hospital/provider columns (dynamic)
        hospital_columns = [col for col in sheet_data.columns if col not in [
            "Service description", "descri[tion", "Ms-DRG", "Rev code", "ICD9,ICD10", "CPT", "coding/def"
        ]]

        # Iterate over each row in the sheet
        for _, row in sheet_data.iterrows():
            service_description = row.get("Service description", "")

            # Extract coding/def column and split it
            coding_def = row.get("coding/def", "")
            if pd.notna(coding_def):
                codes = [code.strip() for code in coding_def.split(" AND ")]  # Split by "AND"

                # Classify each code into Ms-DRG, Rev Code, or CPT
                for code in codes:
                    ms_drg_flag = "X" if code.isdigit() else ""
                    rev_code_flag = "X" if code.startswith("RC") else ""
                    cpt_flag = "X" if code.startswith("CPT") else ""

                    # For each hospital, process the rates/amounts
                    for hospital in hospital_columns:
                        amount_rate = row.get(hospital, "")

                        # Add processed row to output list
                        output_rows.append({
                            "Sheet Name": sheet_name,
                            "Provider": hospital,
                            "Service Description": service_description,
                            "Ms-DRG": ms_drg_flag,
                            "Rev Code": rev_code_flag,
                            "ICD9,ICD10": "",
                            "CPT": cpt_flag,
                            "Coding/Def": code,
                            "Amount Rate": amount_rate if "%" in str(amount_rate) else "",
                            "Amount": amount_rate if "$" in str(amount_rate) else ""
                        })
            else:
                # Handle rows without coding/def but with rate/amount
                for hospital in hospital_columns:
                    amount_rate = row.get(hospital, "")
                    output_rows.append({
                        "Sheet Name": sheet_name,
                        "Provider": hospital,
                        "Service Description": service_description,
                        "Ms-DRG": row.get("Ms-DRG", ""),
                        "Rev Code": row.get("Rev code", ""),
                        "ICD9,ICD10": "",
                        "CPT": row.get("CPT", ""),
                        "Coding/Def": "",
                        "Amount Rate": amount_rate if "%" in str(amount_rate) else "",
                        "Amount": amount_rate if "$" in str(amount_rate) else ""
                    })

    # Convert the output list to a DataFrame
    output_df = pd.DataFrame(output_rows)
    return output_df


# Define the file path for the input and output
input_file_path = 'input_file.xlsx'  # Replace with your input file path
output_file_path = 'formatted_output.xlsx'  # Desired output file path

# Process the data and save it to a new Excel file
output_df = process_data(input_file_path)
output_df.to_excel(output_file_path, index=False)

print(f"Formatted data saved to {output_file_path}")
