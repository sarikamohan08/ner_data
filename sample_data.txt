import spacy
from spacy.training import Example
from spacy.util import minibatch, compounding
from datetime import datetime
import random

# Sample training data
training_data = [
    ("John Doe's patient ID is 123456789 and his SSN is 987-65-4321. His insurance is effective from 08/10/2022.",
     {"entities": [(0, 8, "PATIENT_NAME"), (27, 36, "MEMBER_ID"), (51, 62, "SSN"), (91, 101, "EFFECTIVE_DATE")]}),
    ("Jane Smith's member ID is 987654321 and her SSN is 123-45-6789. The coverage starts from 01/15/2021.",
     {"entities": [(0, 10, "PATIENT_NAME"), (28, 37, "MEMBER_ID"), (52, 63, "SSN"), (84, 94, "EFFECTIVE_DATE")]}),
    # Add more annotated examples here...
]

# Load a blank spaCy model
nlp = spacy.blank("en")

# Create a new entity recognizer and add it to the pipeline
if "ner" not in nlp.pipe_names:
    ner = nlp.add_pipe("ner")
else:
    ner = nlp.get_pipe("ner")

# Add the new labels to the entity recognizer
labels = ["PATIENT_NAME", "MEMBER_ID", "SSN", "EFFECTIVE_DATE"]
for label in labels:
    ner.add_label(label)

# Disable other pipelines to train only NER
other_pipes = [pipe for pipe in nlp.pipe_names if pipe != "ner"]
with nlp.disable_pipes(*other_pipes):
    optimizer = nlp.begin_training()
    for itn in range(30):  # Train for 30 iterations
        random.shuffle(training_data)
        losses = {}
        batches = minibatch(training_data, size=compounding(4., 32., 1.001))
        for batch in batches:
            examples = []
            for text, annotations in batch:
                examples.append(Example.from_dict(nlp.make_doc(text), annotations))
            nlp.update(examples, drop=0.5, losses=losses)
        print(f"Iteration {itn}, Losses: {losses}")

# Save the model
nlp.to_disk("custom_ner_model")

# Load the saved model
nlp = spacy.load("custom_ner_model")

# Function to extract entities and check effective date condition
def extract_effective_before(doc, cutoff_date):
    cutoff_date_obj = datetime.strptime(cutoff_date, "%m/%d/%Y")
    for ent in doc.ents:
        if ent.label_ == "EFFECTIVE_DATE":
            effective_date_obj = datetime.strptime(ent.text, "%m/%d/%Y")
            if effective_date_obj < cutoff_date_obj:
                print(f"Effective date {ent.text} is before {cutoff_date}")
                for ent in doc.ents:
                    print(ent.text, ent.label_)

# Test the model on a new example
doc = nlp("Jane Doe's patient ID is 987654321 and her SSN is 123-45-6789. Her insurance is effective from 09/12/2023.")
extract_effective_before(doc, "08/10/2022")
