import re
import os
import pandas as pd

# Updated date pattern to handle various separators
date_pattern = r'(?i)(?:effective\s+(?:date|from|until)\s*|commence\s+on\s*[-_\s]*)(\w+\s*\d{1,2}[-_\s,]*20\d{2})'

# Updated title extraction pattern
title_pattern = r'(?i)(facility participation agreement|' \
                r'ancillary participation agreement|' \
                r'ambulatory surgery center provider participation agreement|' \
                r'physician and ancillary participation agreement|' \
                r'group participation agreement|' \
                r'physician participation agreement|' \
                r'request for taxpayer|' \
                r'humana\s+physician participation agreement|' \
                r'OSF Healthplans participating specialist physician agreement|' \
                r'humana ancillary participation agreement)'

# Address extraction pattern: match 'address for notice' and capture the next 6-8 lines
address_keyword_pattern = r'(?i)address\s+for\s+notice'

# Function to clean the text (remove extra newlines and whitespace)
def clean_text(text):
    # Remove excessive empty lines and any extra spaces around the text
    text = re.sub(r'\n\s*\n+', '\n', text)  # Replace multiple newlines with a single newline
    text = re.sub(r'\s+', ' ', text)  # Collapse multiple spaces into a single space
    text = text.strip()  # Remove leading and trailing whitespaces
    return text

# Function to extract the block of lines after the address keyword
def extract_address_block(text, keyword_pattern, num_lines=8):
    # Search for the keyword in the text
    keyword_match = re.search(keyword_pattern, text)
    if keyword_match:
        # Split the text into lines starting from after the keyword
        start_pos = keyword_match.end()  # Start extracting after the keyword
        lines_after_keyword = text[start_pos:].splitlines()[:num_lines]  # Extract the next 'num_lines' lines
        
        # Join the lines and clean up the address block
        address_block = "\n".join(lines_after_keyword).strip()
        address_block = clean_text(address_block)  # Clean the extracted address block
        
        return address_block
    return None

# Define the path to the folder containing text files
folder_path = 'path_to_your_folder'  # Replace this with your folder path

# List to store data for the Excel sheet
data = []

# Iterate through all text files in the folder
for filename in os.listdir(folder_path):
    if filename.endswith('.txt'):  # Process only .txt files
        file_path = os.path.join(folder_path, filename)

        # Open and read the contents of the file
        with open(file_path, 'r', encoding='utf-8') as file:
            text = file.read()

            # Clean the text before extracting information
            text = clean_text(text)

            # Search for the first occurrence of the full title in the text
            title_match = re.search(title_pattern, text, re.IGNORECASE)

            # Search for the first occurrence of the date in the text
            date_matches = re.findall(date_pattern, text, re.IGNORECASE)

            # Search for and extract the address block (next 6-8 lines after "address for notice")
            extracted_address = extract_address_block(text, address_keyword_pattern)

            # Extract the title if found
            extracted_title = title_match.group(0).strip() if title_match else None
            
            # If there are matches for dates, join them. Otherwise, set to None.
            extracted_date = "\n".join(date for date in date_matches) if date_matches else None

            # Print debug information to understand what's happening
            print(f"Filename: {filename}")
            print(f"Extracted Title: {extracted_title}")
            print(f"Extracted Date: {extracted_date}")
            print(f"Extracted Address: {extracted_address}")
            print("="*50)  # Separator for clarity

            # Append file name, extracted title, date, and address to the data list
            data.append([filename, extracted_title, extracted_date, extracted_address])

# Convert the data into a pandas DataFrame
df = pd.DataFrame(data, columns=['File Name', 'Extracted Title', 'Extracted Date', 'Extracted Address'])

# Write the DataFrame to an Excel file
output_file = 'extracted_first_title_date_and_address.xlsx'  # Output Excel file name
df.to_excel(output_file, index=False, engine='openpyxl')

print(f"First occurrence of titles, dates, and addresses has been written to {output_file}")
