import os
import pandas as pd
import pytesseract
from PIL import Image
import chardet
import camelot

class FolderProcessor:
    def __init__(self, excel_path, root_folder_path, output_folder_path):
        """
        Initialize the FolderProcessor with paths.
        """
        self.excel_path = excel_path
        self.root_folder_path = root_folder_path
        self.output_folder_path = output_folder_path
        self.subfolders = self.load_subfolders()

    def load_subfolders(self):
        """
        Load the list of subfolders from the Excel file.
        """
        df = pd.read_excel(self.excel_path)
        return df.iloc[:, 0].astype(str).tolist()  # Ensure subfolder names are cast to strings

    def detect_encoding(self, file_path):
        """
        Detect the encoding of a given text file.
        """
        with open(file_path, 'rb') as file:
            rawdata = file.read()
            result = chardet.detect(rawdata)
            return result['encoding']

    def read_text_file(self, file_path):
        """
        Read content from a text file with detected encoding.
        """
        encoding = self.detect_encoding(file_path)
        print(f"Detected encoding for {file_path}: {encoding}")
        try:
            with open(file_path, 'r', encoding=encoding) as file:
                return file.read()
        except UnicodeDecodeError as e:
            print(f"Error reading file {file_path}: {e}")
            return ""

    def read_image_file(self, file_path):
        """
        Extract text from an image file using PyTesseract.
        """
        try:
            # Open the image file
            img = Image.open(file_path)
            # Use PyTesseract to extract text
            text = pytesseract.image_to_string(img)
            return text
        except Exception as e:
            print(f"Error reading image file {file_path}: {e}")
            return ""

    def extract_tables_from_pdf(self, pdf_path):
        """
        Extract tables from a PDF file and return as DataFrames.
        """
        try:
            tables = camelot.read_pdf(pdf_path, pages='all')
            return tables
        except Exception as e:
            print(f"Error extracting tables from {pdf_path}: {e}")
            return []

    def save_tables_as_excel(self, tables, tax_id):
        """
        Simulate saving extracted tables to Excel files in the TaxID folder.
        """
        # Create the folder for TaxID if it doesn't exist
        tax_id_folder_path = os.path.join(self.output_folder_path, str(tax_id))
        if not os.path.exists(tax_id_folder_path):
            os.makedirs(tax_id_folder_path)

        for i, table in enumerate(tables):
            excel_file_path = os.path.join(tax_id_folder_path, f"table_{i + 1}.xlsx")
            # Simulating file save operation
            print(f"[SIMULATE SAVE] Table {i + 1} for TaxID {tax_id} would be saved to {excel_file_path}")

    def read_subfolder_files(self, subfolder_path, tax_id):
        """
        Read all files in the given subfolder and return their combined content.
        """
        subfolder_text_content = ""

        # Loop through each file in the subfolder
        for file_name in os.listdir(subfolder_path):
            file_path = os.path.join(subfolder_path, str(file_name))  # Ensure file names are strings

            # Ensure it's a file and not a directory
            if os.path.isfile(file_path):
                if file_name.lower().endswith(('.png', '.jpg', '.jpeg', '.tiff', '.bmp', '.gif')):
                    # If the file is an image, read it using PyTesseract
                    print(f"Processing image file: {file_name}")
                    subfolder_text_content += self.read_image_file(file_path) + "\n"
                elif file_name.lower().endswith(('.txt', '.csv', '.log')):
                    # If the file is a text file, read it
                    print(f"Processing text file: {file_name}")
                    subfolder_text_content += self.read_text_file(file_path) + "\n"
                elif file_name.lower().endswith('.pdf'):
                    # If the file is a PDF, extract tables
                    print(f"Processing PDF file: {file_name}")
                    tables = self.extract_tables_from_pdf(file_path)
                    self.save_tables_as_excel(tables, tax_id)  # Pass tax_id here

        return subfolder_text_content

    def save_subfolder_content(self, tax_id, content):
        """
        Save the content to the output folder in a folder named after the TaxID.
        """
        # Create 
