import os
import pandas as pd

# Folder containing Excel files
excel_folder = 'path_to_excel_folder'
output_excel = 'combined_address_related_data.xlsx'  # Output Excel file
address_keywords = ['address', 'location', 'street', 'city', 'state', 'zip', 'postal']  # Add more keywords if needed

# Function to check if any cell in a DataFrame contains address-related keywords
def contains_address_keywords(df):
    for keyword in address_keywords:
        if df.apply(lambda x: x.astype(str).str.contains(keyword, case=False, na=False).any()).any():
            return True
    return False

# Function to check if a file is a valid Excel file
def is_valid_excel_file(filepath):
    try:
        pd.ExcelFile(filepath)
        return True
    except Exception as e:
        print(f"Invalid Excel file or error reading '{filepath}': {e}")
        return False

# List to store the data in tabular format
address_data_combined = []

# Iterate over each file in the folder
for filename in os.listdir(excel_folder):
    if filename.lower().endswith('.xlsx'):
        excel_path = os.path.join(excel_folder, filename)
        
        # Check if the file is a valid Excel file
        if not is_valid_excel_file(excel_path):
            print(f"Skipping '{filename}' as it is not a valid Excel file.")
            continue
        
        try:
            # Load the Excel file
            excel_file = pd.ExcelFile(excel_path)
        except Exception as e:
            print(f"Error reading {filename}: {e}. Skipping this file.")
            continue  # Skip to the next file
        
        for sheet_name in excel_file.sheet_names:
            try:
                df = pd.read_excel(excel_path, sheet_name=sheet_name)
            except Exception as e:
                print(f"Error reading sheet '{sheet_name}' in {filename}: {e}. Skipping this sheet.")
                continue  # Skip to the next sheet
            
            # Check if the DataFrame contains address-related keywords
            if contains_address_keywords(df):
                # Flatten the DataFrame into a single row, with file name, sheet name, and content
                flattened_data = {
                    'File Name': filename,
                    'Sheet Name': sheet_name,
                    'Content': df.to_string(index=False)  # Convert entire DataFrame to a string to store in one cell
                }
                address_data_combined.append(flattened_data)
                print(f'Address-related data found in sheet "{sheet_name}" of file "{filename}".')

# Convert the combined data into a DataFrame
address_df = pd.DataFrame(address_data_combined)

# Save the combined data into a single Excel sheet
address_df.to_excel(output_excel, index=False)

print(f"Combined address-related data saved to {output_excel}.")
