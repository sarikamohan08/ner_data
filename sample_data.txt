import os
import pytesseract
import pandas as pd
import camelot
from PIL import Image
import openpyxl

class TaxIDProcessor:
    def __init__(self, excel_file, input_dir, output_dir):
        """
        Initialize the processor with the Excel file containing TaxIDs, input folder, and output folder.
        """
        self.excel_file = excel_file
        self.input_dir = input_dir
        self.output_dir = output_dir
        self.taxids = self.load_taxids()
    
    def load_taxids(self):
        """
        Load TaxIDs from the provided Excel file.
        """
        df = pd.read_excel(self.excel_file)
        return df['taxid'].tolist()
    
    def process_taxids(self):
        """
        Process each TaxID, check for subfolders, and extract data from files in subfolders.
        """
        for taxid in self.taxids:
            taxid_folder = os.path.join(self.input_dir, str(taxid))
            output_taxid_folder = os.path.join(self.output_dir, str(taxid))
            
            # Check if taxid folder exists
            if os.path.exists(taxid_folder):
                os.makedirs(output_taxid_folder, exist_ok=True)
                
                # Process files in the taxid folder
                self.process_folder(taxid_folder, output_taxid_folder)
            else:
                print(f"No subfolder found for taxid {taxid}")
    
    def process_folder(self, taxid_folder, output_taxid_folder):
        """
        Process files within a TaxID folder, extracting text and tables.
        """
        for root, dirs, files in os.walk(taxid_folder):
            for file in files:
                file_path = os.path.join(root, file)
                
                # If the file is an image, use Pytesseract for text extraction
                if file.lower().endswith(('.png', '.jpg', '.jpeg')):
                    self.extract_text(file_path, output_taxid_folder)
                
                # If the file is a PDF, use Camelot for table extraction
                elif file.lower().endswith('.pdf'):
                    self.extract_tables(file_path, output_taxid_folder)
    
    def extract_text(self, image_path, output_taxid_folder):
        """
        Extract text from an image using Pytesseract and save it as a .txt file.
        """
        img = Image.open(image_path)
        text = pytesseract.image_to_string(img)
        
        # Save the extracted text to a .txt file
        text_filename = os.path.join(output_taxid_folder, os.path.basename(image_path).replace('.png', '.txt').replace('.jpg', '.txt').replace('.jpeg', '.txt'))
        with open(text_filename, 'w') as f:
            f.write(text)
        print(f"Extracted text and saved to {text_filename}")
    
    def extract_tables(self, pdf_path, output_taxid_folder):
        """
        Extract tables from a PDF using Camelot and save as an Excel file.
        """
        tables = camelot.read_pdf(pdf_path, pages='all')
        
        # Save each table to an Excel file
        if tables:
            excel_filename = os.path.join(output_taxid_folder, os.path.basename(pdf_path).replace('.pdf', '.xlsx'))
            with pd.ExcelWriter(excel_filename, engine='openpyxl') as writer:
                for i, table in enumerate(tables):
                    table.df.to_excel(writer, sheet_name=f'Table_{i+1}', index=False)
            print(f"Extracted tables and saved to {excel_filename}")
        else:
            print(f"No tables found in {pdf_path}")

# Example Usage:
excel_file = 'taxid_list.xlsx'  # Path to the Excel file containing taxid
input_dir = 'input_folder'  # Input folder where taxid subfolders are located
output_dir = 'output_folder'  # Output folder to store the results

processor = TaxIDProcessor(excel_file, input_dir, output_dir)
processor.process_taxids()
