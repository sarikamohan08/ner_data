import requests
from bs4 import BeautifulSoup
import zipfile
import io
import os

# URL where the export button is located
export_url = "https://example.com/export"

# Step 1: Access the export page
response = requests.get(export_url)
if response.status_code != 200:
    print("Failed to access the export page.")
    exit()

# Step 2: Parse the page to find the "Export" button and trigger it
soup = BeautifulSoup(response.content, 'html.parser')
export_button = soup.find('button', {'id': 'export_button_id'})  # Update with actual button ID or class

if not export_button:
    print("Export button not found.")
    exit()

# Step 3: Find all links and filter for "CSV for Excel"
csv_links = soup.find_all('a', text="CSV for Excel")  # Finds links with exact text "CSV for Excel"

if not csv_links:
    print("CSV for Excel link not found.")
    exit()

# Assuming the first match is the correct link
csv_download_url = csv_links[0]['href']
print(f"Found CSV download URL: {csv_download_url}")

# Step 4: Download the ZIP file containing the CSV
response = requests.get(csv_download_url)
if response.status_code == 200:
    print("CSV ZIP file downloaded.")
else:
    print("Failed to download CSV ZIP file.")
    exit()

# Step 5: Extract the ZIP file and save the CSV
zip_file = zipfile.ZipFile(io.BytesIO(response.content))
output_dir = "extracted_csv"
os.makedirs(output_dir, exist_ok=True)

for file_name in zip_file.namelist():
    if file_name.endswith(".csv"):
        zip_file.extract(file_name, output_dir)
        print(f"Extracted: {file_name}")

print(f"All CSV files extracted to {output_dir}.")
