import os
import pandas as pd
import pytesseract
import camelot
from pdf2image import convert_from_path

class PDFExtractor:
    def __init__(self, excel_file, root_folder, output_folder):
        self.excel_file = excel_file
        self.root_folder = root_folder
        self.output_folder = output_folder
        os.makedirs(self.output_folder, exist_ok=True)  # Create output folder if not exists
        self.ids = self.load_ids()

    def load_ids(self):
        """Reads the Excel file and extracts the ID column."""
        df = pd.read_excel(self.excel_file)
        return df["ID"].astype(str).tolist()  # Convert IDs to string

    def find_pdf_files(self, id_value):
        """Finds PDF files in the root folder containing the given ID."""
        return [f for f in os.listdir(self.root_folder) if id_value in f and f.endswith(".pdf")]

    def extract_text(self, pdf_path):
        """Extracts text from a PDF using Tesseract."""
        extracted_text = ""
        images = convert_from_path(pdf_path)
        for image in images:
            extracted_text += pytesseract.image_to_string(image)
        return extracted_text

    def extract_tables(self, pdf_path, xls_output_path):
        """Extracts tables from a PDF using Camelot and saves as Excel."""
        tables = camelot.read_pdf(pdf_path, pages="all")
        if tables.n > 0:
            tables.export(xls_output_path, f="excel")

    def process_pdfs(self):
        """Processes all PDFs that match IDs, extracts text and tables."""
        for id_value in self.ids:
            pdf_files = self.find_pdf_files(id_value)
            for pdf_file in pdf_files:
                pdf_path = os.path.join(self.root_folder, pdf_file)
                txt_output_path = os.path.join(self.output_folder, f"{pdf_file}.txt")
                xls_output_path = os.path.join(self.output_folder, f"{pdf_file}.xls")

                # Extract and save text
                extracted_text = self.extract_text(pdf_path)
                with open(txt_output_path, "w", encoding="utf-8") as txt_file:
                    txt_file.write(extracted_text)

                # Extract and save tables
                self.extract_tables(pdf_path, xls_output_path)

                print(f"Processed: {pdf_file}")

        print("Extraction complete!")

# Usage
if __name__ == "__main__":
    extractor = PDFExtractor(
        excel_file="data.xlsx",  # Path to Excel file
        root_folder="pdfs/",  # Folder where PDFs are stored
        output_folder="extracted_output/"  # Folder for extracted text/tables
    )
    extractor.process_pdfs()
