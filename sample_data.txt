from openai import OpenAI
import pandas as pd
import json

# Initialize OpenAI client (ensure OPENAI_API_KEY is set in environment)
client = OpenAI()

# =========================
# ğŸ§  PROMPT
# =========================
prompt = """
You are a healthcare contract data extraction assistant.

You will receive a healthcare contract as plain text.
Your task is to extract structured reimbursement data and return
a single pandas DataFrame named **Reimbursement_Details**.

Return ONLY the pandas DataFrame â€” no markdown, no prose.

===============================================================
### DATAFRAME â€” REIMBURSEMENT_DETAILS
===============================================================
Columns:
[
  "Provider_Name", "Effective_Date", "Termination_Date", "NPI_Number", "Tax_ID",
  "Service_Type", "Service", "Reimbursement_Rate", "Reimbursement_Amount",
  "Code", "Revenue_Code",
  "Revenue_Ind", "DRG_Ind", "CPT_Ind", "HCPCS_Ind", "ICD_Ind",
  "Description"
]

===============================================================
### EXTRACTION RULES
===============================================================

1. **Provider Linkage**
   - Each row must include provider details: Provider_Name, Effective_Date, Termination_Date, NPI_Number, Tax_ID.
   - If multiple provider sections exist, link each service block to the correct provider.
   - If a service block lacks provider info, reuse the last providerâ€™s details.

2. **Service_Type (Inpatient / Outpatient)**
   - Detect â€œInpatientâ€ or â€œOutpatientâ€ headings above service sections.
   - Assign that to `Service_Type`.
   - Leave blank for SNF or unlabeled sections.

3. **Service**
   - The line item or subsection name (â€œLevel 1â€, â€œCovered Services renderedâ€, etc.).
   - â€œCovered Services rendered/provided/not listedâ€ appear here â€” NOT under Service_Type.

4. **Reimbursement_Rate**
   - Percent or ratio values like â€œ70%â€, â€œ100%â€.

5. **Reimbursement_Amount**
   - Fixed dollar or per diem values like â€œ$395â€, â€œ$740 per dayâ€.

6. **Code**
   - DRG / CPT / HCPCS / ICD9/10 / Fee Schedule references.
     Examples:
     - â€œDRG 201â€“544â€
     - â€œHCPCS J3490â€
     - â€œHumanaâ€™s 005â€“270 Fee Scheduleâ€

7. **Revenue_Code**
   - Numeric or text revenue code (â€œ191â€, â€œRev 192â€).

8. **Indicators**
   - Revenue_Ind = 1 if revenue code found.
   - DRG_Ind = 1 if DRG present.
   - CPT_Ind = 1 if CPT present.
   - HCPCS_Ind = 1 if HCPCS present.
   - ICD_Ind = 1 if ICD9 or ICD10 present.

9. **Description**
   - Include detailed service or coverage text exactly as written.

===============================================================
### OUTPUT RULES
===============================================================
1. Return a single pandas DataFrame named `Reimbursement_Details`.
2. Include full provider info and inferred Service_Type for every row.
3. Leave blanks where data is missing.
4. Output ONLY the DataFrame â€” no markdown or explanations.
"""

# =========================
# ğŸ§© MAIN EXECUTION
# =========================

# Step 1: Read your healthcare contract text file
text_file = "contract.txt"  # ğŸ‘ˆ Replace with your file path
with open(text_file, "r", encoding="utf-8") as f:
    contract_text = f.read()

# Step 2: Send to GPT-4o
response = client.chat.completions.create(
    model="gpt-4o",
    temperature=0,
    messages=[
        {"role": "system", "content": "You are a precise healthcare contract data extraction model."},
        {"role": "user", "content": prompt},
        {"role": "user", "content": contract_text}
    ]
)

# Step 3: Parse response
raw_output = response.choices[0].message.content.strip()
print("\n=== RAW MODEL OUTPUT ===\n")
print(raw_output)

# Step 4: Try to convert JSON â†’ DataFrame
try:
    df = pd.DataFrame(json.loads(raw_output))
    df = df.reindex(columns=[
        "Provider_Name", "Effective_Date", "Termination_Date", "NPI_Number", "Tax_ID",
        "Service_Type", "Service", "Reimbursement_Rate", "Reimbursement_Amount",
        "Code", "Revenue_Code",
        "Revenue_Ind", "DRG_Ind", "CPT_Ind", "HCPCS_Ind", "ICD_Ind",
        "Description"
    ])
    print("\nâœ… Extracted DataFrame:\n")
    print(df)
except Exception:
    print("\nâš ï¸ Could not parse JSON. Review model output above.\n")
