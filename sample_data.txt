import os
import pandas as pd
import pytesseract
from pdf2image import convert_from_path

# Ensure pytesseract is installed and configured correctly
pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'  # Adjust path as needed

def extract_text_from_pdf(pdf_path):
    """
    Extract text from a PDF using pytesseract after converting to images.
    """
    text = ""
    try:
        images = convert_from_path(pdf_path)
        for image in images:
            text += pytesseract.image_to_string(image)
    except Exception as e:
        print(f"Error processing {pdf_path}: {e}")
    return text

def check_ids_in_files(excel_file, folder_path, output_file):
    """
    Check if IDs from an Excel file are present in filenames or file content in a folder of PDFs.
    """
    # Load the Excel file
    df = pd.read_excel(excel_file)
    ids = df['ID'].astype(str).tolist()

    # Prepare results list
    results = []

    # Iterate over files in the folder
    for file_name in os.listdir(folder_path):
        if file_name.endswith('.pdf'):
            # Check if any ID is in the filename
            matching_ids = [id_ for id_ in ids if id_ in file_name]
            if matching_ids:
                results.append({'File': file_name, 'Matching IDs': matching_ids})
                continue

            # Extract text from the file and search for IDs
            pdf_path = os.path.join(folder_path, file_name)
            file_text = extract_text_from_pdf(pdf_path)
            matching_ids = [id_ for id_ in ids if id_ in file_text]
            if matching_ids:
                results.append({'File': file_name, 'Matching IDs': matching_ids})

    # Save results to an Excel file
    result_df = pd.DataFrame(results)
    result_df.to_excel(output_file, index=False)
    print(f"Results saved to {output_file}")

# Usage
excel_file = 'ids.xlsx'  # Path to your Excel file containing IDs
folder_path = 'pdf_folder'  # Path to the folder containing PDF files
output_file = 'output_results.xlsx'  # Path to save the results

check_ids_in_files(excel_file, folder_path, output_file)
