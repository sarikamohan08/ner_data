import os
import pandas as pd

# Folder containing Excel files
excel_folder = 'path_to_excel_folder'
output_excel = 'combined_address_related_data.xlsx'  # Output Excel file
address_keywords = ['address', 'location', 'street', 'city', 'state', 'zip', 'postal']  # Add more keywords if needed

# Function to check if any cell in a DataFrame contains address-related keywords
def contains_address_keywords(df):
    for keyword in address_keywords:
        if df.apply(lambda x: x.astype(str).str.contains(keyword, case=False, na=False).any()).any():
            return True
    return False

# Function to check if a file is a valid Excel file
def is_valid_excel_file(filepath):
    try:
        pd.ExcelFile(filepath)
        return True
    except Exception as e:
        print(f"Invalid Excel file or error reading '{filepath}': {e}")
        return False

# List to store all DataFrames with address-related data
combined_data = []

# Iterate over each file in the folder
for filename in os.listdir(excel_folder):
    if filename.lower().endswith('.xlsx'):
        excel_path = os.path.join(excel_folder, filename)
        
        # Check if the file is a valid Excel file
        if not is_valid_excel_file(excel_path):
            print(f"Skipping '{filename}' as it is not a valid Excel file.")
            continue
        
        try:
            # Load the Excel file
            excel_file = pd.ExcelFile(excel_path)
        except Exception as e:
            print(f"Error reading {filename}: {e}. Skipping this file.")
            continue  # Skip to the next file
        
        for sheet_name in excel_file.sheet_names:
            try:
                df = pd.read_excel(excel_path, sheet_name=sheet_name)
            except Exception as e:
                print(f"Error reading sheet '{sheet_name}' in {filename}: {e}. Skipping this sheet.")
                continue  # Skip to the next sheet
            
            # Check if the DataFrame contains address-related keywords
            if contains_address_keywords(df):
                # Add filename and sheet name as additional columns to identify the source of the data
                df['Source_File'] = filename
                df['Sheet_Name'] = sheet_name
                combined_data.append(df)  # Append the DataFrame to the list

# Combine all DataFrames into one single DataFrame
if combined_data:
    combined_df = pd.concat(combined_data, ignore_index=True)
    
    # Save the combined data into a single sheet in an Excel file
    combined_df.to_excel(output_excel, index=False)
    print(f"Combined address-related data saved to {output_excel}.")
else:
    print("No address-related data found in any of the files.")
