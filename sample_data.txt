import os
import pytesseract
from pdf2image import convert_from_path
import pandas as pd
import openai
from dotenv import load_dotenv

# === Load API Key ===
load_dotenv()
openai.api_key = os.getenv("OPENAI_API_KEY")

# === Configuration ===
pdf_path = "./your_file.pdf"  # <-- your scanned PDF file
ocr_lang = 'eng'
output_excel = "extracted_data_llm.xlsx"

# === Step 1: OCR PDF ===
def extract_text_from_scanned_pdf(pdf_path):
    print(f"OCR processing: {pdf_path}")
    pages = convert_from_path(pdf_path)
    full_text = ""
    for i, page in enumerate(pages):
        text = pytesseract.image_to_string(page, lang=ocr_lang)
        full_text += f"\n--- Page {i+1} ---\n{text}"
    return full_text

# === Step 2: Ask LLM ===
def ask_llm(prompt, context):
    print(f"Asking LLM: {prompt}")
    try:
        response = openai.ChatCompletion.create(
            model="gpt-4",  # or "gpt-3.5-turbo"
            messages=[
                {"role": "system", "content": "You are an expert document reader. Extract only the answer from the document text."},
                {"role": "user", "content": f"Document Text:\n{context}\n\nQuestion: {prompt}\n\nOnly return the exact value or answer, nothing else."}
            ],
            temperature=0.0
        )
        return response['choices'][0]['message']['content'].strip()
    except Exception as e:
        print(f"Error: {e}")
        return "Error"

# === Step 3: Process PDF ===
def process_pdf(pdf_path):
    text = extract_text_from_scanned_pdf(pdf_path)

    prompts = [
        "extract effective date",
        "extract tax id",
        "extract npi"
    ]

    results = {}
    for prompt in prompts:
        answer = ask_llm(prompt, text)
        results[prompt] = answer

    return results

# === Step 4: Run and Export ===
row = {"filename": os.path.basename(pdf_path)}
row.update(process_pdf(pdf_path))

df = pd.DataFrame([row])
df.to_excel(output_excel, index=False)

print(f"\nâœ… Done. Results saved to {output_excel}")
