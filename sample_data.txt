import pandas as pd
import re

def transform_excel(input_file, output_file):
    # Load all sheets from the input file
    sheets = pd.read_excel(input_file, sheet_name=None)
    
    transformed_data = []

    # Process each sheet
    for sheet_name, df in sheets.items():
        # Extract hospital/provider columns dynamically
        provider_columns = [col for col in df.columns if 'hospital' in col.lower()]
        service_description_column = [col for col in df.columns if 'service description' in col.lower()]
        service_description_column = service_description_column[0] if service_description_column else None

        # Iterate through rows
        for _, row in df.iterrows():
            service_description = row[service_description_column] if service_description_column else ""
            service_description = service_description.split(':')[-1].strip()  # Extract text after ":"

            # Check for spread-out Coding/Def data
            coding_cells = []
            for col in df.columns:
                if 'coding/def' in col.lower():
                    cell_value = row[col]
                    if pd.notna(cell_value):
                        coding_cells.append(str(cell_value).replace('AND', ',').split(','))

            # Flatten the coding_cells list
            coding_values = [code.strip() for sublist in coding_cells for code in sublist]

            # Loop through each hospital/provider column
            for provider in provider_columns:
                provider_name = provider.split(' ')[0].strip()  # Extract provider name from column header
                rate = row[provider]
                
                for code in coding_values:
                    if not code: continue

                    # Identify type of code (Ms-DRG, Rev Code, CPT)
                    if re.match(r'^\d+$', code):  # Ms-DRG
                        ms_drg = 'X'
                        rev_code, cpt = '', ''
                    elif code.startswith('RC'):  # Rev Code
                        ms_drg, rev_code, cpt = '', code, ''
                    elif code.startswith('CPT'):  # CPT Code
                        ms_drg, rev_code, cpt = '', '', code
                    else:  # Assume Ms-DRG if unmatched
                        ms_drg, rev_code, cpt = 'X', '', ''
                    
                    # Add a new row for the transformed data
                    transformed_data.append({
                        'Sheet Name': sheet_name,
                        'Provider': provider_name,
                        'Service Description': service_description,
                        'Ms-DRG': ms_drg,
                        'Rev Code': rev_code,
                        'ICD9,ICD10': row.get('ICD9,ICD10', ''),
                        'CPT': cpt,
                        'Coding/Def': code,
                        'Amount Rate': rate,
                        'Amount': row.get('amount', '')  # Adjust the column name if different
                    })

    # Convert the list to a DataFrame
    transformed_df = pd.DataFrame(transformed_data)

    # Write the transformed data to a new Excel file
    transformed_df.to_excel(output_file, index=False)
    print(f"Transformed data saved to {output_file}")

# Example usage
input_file = 'input_multisheets.xlsx'  # Replace with your input file path
output_file = 'output_transformed.xlsx'  # Replace with your desired output file path
transform_excel(input_file, output_file)
