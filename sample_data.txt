import pandas as pd

# Load the Excel file with multiple sheets
input_file = 'input_file.xlsx'  # Replace with your Excel file name
output_file = 'output_file.xlsx'

# Load all sheets from the Excel file into a dictionary of DataFrames
sheets = pd.read_excel(input_file, sheet_name=None)

# Placeholder for transformed data
transformed_data = []

# Iterate through each sheet
for sheet_name, df in sheets.items():
    # Identify provider columns dynamically (excluding standard columns)
    standard_columns = ['Line', 'Service description', 'descri[tion', 'Ms-DRG', 'Rev code', 'ICD9,ICD10', 'CPT', 'coding/def']
    provider_columns = [col for col in df.columns if col not in standard_columns]
    
    # Process each sheet
    for index, row in df.iterrows():
        if pd.notna(row.get('Service description')):
            # Repeat rows for each provider and multiple coding/def values
            coding_values = str(row.get('coding/def', '')).split(' AND ')
            for coding_value in coding_values:
                for provider in provider_columns:
                    transformed_data.append({
                        'Provider': provider,
                        'Service Description': row.get('Service description'),
                        'MS-DRG': row.get('Ms-DRG'),
                        'Rev Code': row.get('Rev code'),
                        'ICD9, ICD10': row.get('ICD9,ICD10'),
                        'CPT': row.get('CPT'),
                        'Coding/Def': coding_value.strip(),
                        'Billed Charges/Percent': row.get(provider)
                    })

# Create a new DataFrame from the transformed data
transformed_df = pd.DataFrame(transformed_data)

# Save the transformed data to a new Excel file
transformed_df.to_excel(output_file, index=False)

print(f"Transformed data saved to {output_file}")
