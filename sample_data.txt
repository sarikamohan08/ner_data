import pandas as pd

def process_data(file_path):
    # Load all sheets in the Excel file
    all_sheets = pd.read_excel(file_path, sheet_name=None)
    
    # Prepare an empty list to hold the processed rows
    output_rows = []

    # Iterate over each sheet
    for sheet_name, sheet_data in all_sheets.items():
        # Get the list of provider names (all columns except the first 8 columns)
        hospital_columns = [col for col in sheet_data.columns if col not in ["Service description", "descri[tion", "Ms-DRG", "Rev code", "ICD9,ICD10", "CPT", "coding/def"]]

        # Iterate over each row in the sheet
        for _, row in sheet_data.iterrows():
            service_description = row["Service description"]
            ms_drg = row["Ms-DRG"]
            rev_code = row["Rev code"]
            cpt = row["CPT"]
            coding_def = row["coding/def"]
            
            # For each hospital, extract rate and amount if present
            for hospital in hospital_columns:
                amount_rate = row[hospital]
                
                # Split coding definitions by 'AND' and commas, then process each part
                if pd.notna(coding_def):
                    codes = coding_def.replace(" AND ", ",").split(",")
                    for code in codes:
                        code = code.strip()  # Clean up whitespace around each code
                        
                        # Determine the category of each code
                        if code.startswith("RC"):
                            rev_code_flag = "X"
                            ms_drg_flag, cpt_flag = "", ""
                        elif code.startswith("CPT"):
                            cpt_flag = "X"
                            ms_drg_flag, rev_code_flag = "", ""
                        else:
                            ms_drg_flag = "X"
                            rev_code_flag, cpt_flag = "", ""
                        
                        # Add processed row to output list
                        output_rows.append({
                            "Sheet Name": sheet_name,
                            "Provider": hospital,
                            "Service Description": service_description,
                            "Ms-DRG": ms_drg_flag,
                            "Rev Code": rev_code_flag,
                            "ICD9,ICD10": "",
                            "CPT": cpt_flag,
                            "Coding/Def": code,
                            "Amount Rate": amount_rate if "%" in str(amount_rate) else "",
                            "Amount": amount_rate if "$" in str(amount_rate) else ""
                        })
                else:
                    # Handle rows with no "coding/def" entries but with rate/amount
                    output_rows.append({
                        "Sheet Name": sheet_name,
                        "Provider": hospital,
                        "Service Description": service_description,
                        "Ms-DRG": ms_drg,
                        "Rev Code": rev_code,
                        "ICD9,ICD10": "",
                        "CPT": cpt,
                        "Coding/Def": "",
                        "Amount Rate": amount_rate if "%" in str(amount_rate) else "",
                        "Amount": amount_rate if "$" in str(amount_rate) else ""
                    })

    # Convert the output list to a DataFrame
    output_df = pd.DataFrame(output_rows)
    
    return output_df

# Use the function to process data from an Excel file and save it as a new sheet in a new file
file_path = 'input_file.xlsx'  # Replace with your input file path
output_df = process_data(file_path)
output_df.to_excel("formatted_output.xlsx", index=False)  # Save the formatted data to an Excel file
