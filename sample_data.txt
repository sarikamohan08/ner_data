import pandas as pd

def extract_data_from_excel(file_path):
    # Load the Excel file with multiple sheets
    excel_data = pd.ExcelFile(file_path)
    output_data = []

    for sheet_name in excel_data.sheet_names:
        # Load the sheet into a DataFrame
        sheet_data = pd.read_excel(file_path, sheet_name=sheet_name, header=None)

        # Locate header row dynamically
        header_row = sheet_data[sheet_data.apply(lambda row: row.str.contains("Line", na=False).any(), axis=1)].index[0]
        
        # Extract provider names
        provider_names = sheet_data.iloc[header_row + 1, 8:].dropna().tolist()
        
        # Set columns based on header row
        sheet_data.columns = sheet_data.iloc[header_row]
        sheet_data = sheet_data.iloc[header_row + 2:]  # Exclude header rows

        # Process each row in the DataFrame
        for _, row in sheet_data.iterrows():
            service_description = row['Service description']
            ms_drg = 'X' if row['Ms-DRG'] == 'X' else ''
            rev_code = row['Rev code'] if pd.notna(row['Rev code']) else ''
            icd_cpt = row['CPT'] if pd.notna(row['CPT']) else ''
            coding_def = row['coding/def'] if pd.notna(row['coding/def']) else ''
            
            for idx, provider in enumerate(provider_names):
                amount_rate = row.iloc[8 + idx] if pd.notna(row.iloc[8 + idx]) and '%' in str(row.iloc[8 + idx]) else ''
                amount = row.iloc[8 + idx] if pd.notna(row.iloc[8 + idx]) and '$' in str(row.iloc[8 + idx]) else ''

                output_data.append([
                    sheet_name, provider, service_description, ms_drg, rev_code, '', icd_cpt, coding_def, amount_rate, amount
                ])

    # Convert output data to DataFrame
    output_df = pd.DataFrame(output_data, columns=[
        'Sheet Name', 'Provider', 'Service Description', 'Ms-DRG', 'Rev Code', 'ICD9,ICD10', 'CPT', 'Coding/Def', 'Amount Rate', 'Amount'
    ])

    return output_df

# Example usage
file_path = "path_to_your_excel_file.xlsx"
output_df = extract_data_from_excel(file_path)
output_df.to_csv("output_table.csv", index=False)  # Save to CSV if needed
print(output_df)
