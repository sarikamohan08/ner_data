import pandas as pd

# Load the Excel file (adjust the file path as needed)
file_path = 'your_excel_file.xlsx'
xls = pd.ExcelFile(file_path)

# Create an empty list to store the formatted data across all sheets
all_data = []

# Loop through each sheet in the Excel file
for sheet_name in xls.sheet_names:
    # Read the current sheet
    df = pd.read_excel(xls, sheet_name=sheet_name)
    
    # Rename columns for consistency and drop unnecessary rows if needed
    df.columns = df.iloc[0]
    df = df[1:].reset_index(drop=True)
    
    # Define the columns of interest based on the example structure
    hospital_columns = ["poinciana hospital", "putuam hospital", "osceola hospital"]
    
    # Process each row in the sheet to create the new structured format
    for _, row in df.iterrows():
        service_description = row['Service description']
        coding_def = str(row['coding/def']).split(',')
        
        # Separate Ms-DRG, Rev code, ICD9, ICD10, and CPT values
        ms_drg_codes = [code for code in coding_def if 'IP' not in code and code.isnumeric()]
        rev_code_values = [code for code in coding_def if 'RC' in code]
        cpt_codes = [code for code in coding_def if 'CPT' in code]
        
        # Loop through each hospital column to add entries for each hospital
        for hospital in hospital_columns:
            amount_rate = row[hospital] if '%' in str(row[hospital]) else ''
            amount = row[hospital] if '$' in str(row[hospital]) else ''
            
            # Create rows with "X" indicators and add respective code in Coding/Def
            for code in ms_drg_codes:
                all_data.append([hospital, service_description, 'X', '', '', '', amount_rate, amount, code])
            for code in rev_code_values:
                all_data.append([hospital, service_description, '', 'X', '', '', amount_rate, amount, code])
            for code in cpt_codes:
                all_data.append([hospital, service_description, '', '', '', 'X', amount_rate, amount, code])

# Create the final DataFrame
columns = ["Provider", "Service Description", "Ms-DRG", "Rev Code", "ICD9,ICD10", "CPT", "Amount Rate", "Amount", "Coding/Def"]
formatted_df = pd.DataFrame(all_data, columns=columns)

# Display or save the final table
print(formatted_df)
# Optional: Save to an Excel file
formatted_df.to_excel('formatted_output.xlsx', index=False)
