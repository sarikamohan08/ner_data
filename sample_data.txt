from selenium import webdriver
from selenium.webdriver.edge.service import Service
from selenium.webdriver.edge.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import time
import os

def download_cms_otp_data(download_path):
    # Setup Edge options
    edge_options = Options()
    edge_options.add_experimental_option("prefs", {
        "download.default_directory": download_path,
        "download.prompt_for_download": False,
        "download.directory_upgrade": True,
        "safebrowsing.enabled": True
    })

    # Initialize Edge driver
    driver = webdriver.Edge(options=edge_options)
    
    try:
        # Navigate to the CMS website
        url = "https://data.cms.gov/provider-characteristics/medicare-provider-supplier-enrollment/opioid-treatment-program-providers/data"
        driver.get(url)
        
        # Wait for the export button to be clickable and click it
        export_button = WebDriverWait(driver, 20).until(
            EC.element_to_be_clickable((By.XPATH, "//button[contains(text(), 'Export')]"))
        )
        export_button.click()
        
        # Wait for and click the CSV for Excel option
        csv_option = WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable((By.XPATH, "//button[contains(text(), 'CSV for Excel')]"))
        )
        csv_option.click()
        
        # Wait for and click the final export button
        final_export = WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable((By.XPATH, "//button[contains(text(), 'Export')]"))
        )
        final_export.click()
        
        # Wait for download to complete (adjust time if needed)
        time.sleep(10)
        
        print(f"Download completed. Check {download_path} for the file.")
        
    except Exception as e:
        print(f"An error occurred: {str(e)}")
    
    finally:
        driver.quit()

if __name__ == "__main__":
    # Specify your download path here
    download_directory = r"C:\Downloads\CMS_Data"  # Change this to your preferred download location
    
    # Create the directory if it doesn't exist
    os.makedirs(download_directory, exist_ok=True)
    
    # Run the download function
    download_cms_otp_data(download_directory)
