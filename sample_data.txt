import os
import camelot
import pandas as pd
from openpyxl import Workbook

class PDFTableExtractor:
    def __init__(self, pdf_folder, excel_folder, output_excel, address_keywords=None):
        self.pdf_folder = pdf_folder
        self.excel_folder = excel_folder
        self.output_excel = output_excel
        self.address_keywords = address_keywords or ['address', 'location', 'street', 'city', 'state', 'zip', 'postal']
        self.service_address_keyword = 'service address'
        self.address_data_combined = {}
        self.service_address_data_combined = {}

        # Create the output folder if it doesn't exist
        if not os.path.exists(self.excel_folder):
            os.makedirs(self.excel_folder)

    def extract_tables_from_pdf(self, pdf_path):
        """
        Extract tables from a PDF file and return them.
        """
        try:
            tables = camelot.read_pdf(pdf_path, pages='all')
            if not tables:
                print(f"No tables found in {os.path.basename(pdf_path)}.")
            return tables
        except Exception as e:
            print(f"Error extracting tables from {os.path.basename(pdf_path)}: {e}")
            return None

    def contains_keywords(self, df, keyword_list):
        """
        Check if any cell in a DataFrame contains any keyword from a given list.
        """
        for keyword in keyword_list:
            if df.apply(lambda x: x.astype(str).str.contains(keyword, case=False, na=False).any()).any():
                return True
        return False

    def save_tables_to_excel(self, tables, filename):
        """
        Save extracted tables to an Excel file with a sheet for each table.
        """
        excel_filename = os.path.splitext(filename)[0] + '.xlsx'
        excel_path = os.path.join(self.excel_folder, excel_filename)

        file_data = []  # To store address-related data
        service_address_data = []  # To store service address data

        with pd.ExcelWriter(excel_path, engine='openpyxl') as writer:
            for i, table in enumerate(tables):
                df = table.df

                if df.empty:
                    print(f"Table {i+1} in {filename} is empty. Skipping...")
                    continue

                sheet_name = f'Table_{i+1}'
                df.to_excel(writer, sheet_name=sheet_name, index=False)

                # Check for address-related keywords
                if self.contains_keywords(df, self.address_keywords):
                    file_data.append(df.to_string(index=False))
                    print(f"Address-related data found in table {i+1} of file {filename}.")

                # Check for service address specifically
                if self.contains_keywords(df, [self.service_address_keyword]):
                    service_address_data.append(df.to_string(index=False))
                    print(f"Service Address data found in table {i+1} of file {filename}.")

        return file_data, service_address_data  # Return both address-related and service address data

    def process_pdfs(self):
        """
        Process all PDFs in the folder, extract tables, save them, and look for address-related and service address data.
        """
        for filename in os.listdir(self.pdf_folder):
            if filename.endswith('.pdf'):
                pdf_path = os.path.join(self.pdf_folder, filename)
                tables = self.extract_tables_from_pdf(pdf_path)

                if not tables:
                    print(f"Skipping {filename} (no tables found).")
                    continue

                # Save tables to Excel and extract address-related and service address data
                file_data, service_address_data = self.save_tables_to_excel(tables, filename)

                if file_data:
                    self.address_data_combined[filename] = file_data

                if service_address_data:
                    self.service_address_data_combined[filename] = service_address_data

    def save_combined_address_data(self):
        """
        Save all extracted address-related data into a single Excel file.
        """
        if self.address_data_combined:
            output_data = []
            for file_name, sheets_data in self.address_data_combined.items():
                row = [file_name] + sheets_data
                output_data.append(row)

            max_columns = max(len(row) for row in output_data)
            output_df = pd.DataFrame(output_data, columns=['File Name'] + [f'Address Data {i+1}' for i in range(max_columns - 1)])

            return output_df
        else:
            print("No address-related data found.")
            return pd.DataFrame()

    def save_combined_service_address_data(self):
        """
        Save all extracted service address data into a separate Excel file.
        """
        if self.service_address_data_combined:
            output_data = []
            for file_name, sheets_data in self.service_address_data_combined.items():
                row = [file_name] + sheets_data
                output_data.append(row)

            max_columns = max(len(row) for row in output_data)
            output_df = pd.DataFrame(output_data, columns=['File Name'] + [f'Service Address {i+1}' for i in range(max_columns - 1)])

            return output_df
        else:
            print("No service address data found.")
            return pd.DataFrame()

    def merge_with_other_df(self, other_df):
        """
        Merge the address-related data and service address data with another DataFrame based on the filename.
        """
        # Extract the combined address-related data into a DataFrame
        combined_address_df = self.save_combined_address_data()

        # Extract service address data into a DataFrame
        combined_service_address_df = self.save_combined_service_address_data()

        if combined_address_df.empty and combined_service_address_df.empty:
            print("No address or service address data available to merge.")
            return other_df

        # Merge with the other DataFrame on 'File Name'
        merged_df = pd.merge(other_df, combined_address_df, how='left', left_on='filename_column', right_on='File Name')

        # Merge the service address data separately
        merged_df = pd.merge(merged_df, combined_service_address_df, how='left', on='File Name', suffixes=('', '_cam'))

        return merged_df

    def run(self, other_df_path, merged_output_excel):
        """
        Main function to process PDFs, merge with another DataFrame, and save the final result.
        """
        print("Processing PDFs...")
        self.process_pdfs()

        print("Merging with the provided DataFrame...")
        # Load the other DataFrame (assuming it's in CSV format; adjust accordingly if it's in a different format)
        other_df = pd.read_csv(other_df_path)

        # Merge the extracted data with the other DataFrame
        merged_df = self.merge_with_other_df(other_df)

        print(f"Saving the merged data to {merged_output_excel}...")
        merged_df.to_excel(merged_output_excel, index=False)
        print("All PDFs have been processed and data merged successfully.")


# Usage
if __name__ == "__main__":
    pdf_folder = 'path_to_pdf_folder'
    excel_folder = 'path_to_excel_folder'
    output_excel = 'combined_address_related_data.xlsx'
    other_df_path = 'path_to_other_df.csv'  # Path to the other DataFrame (e.g., a CSV file)
    merged_output_excel = 'merged_output.xlsx'  # Output Excel file after merging

    extractor = PDFTableExtractor(pdf_folder, excel_folder, output_excel)
    extractor.run(other_df_path, merged_output_excel)
